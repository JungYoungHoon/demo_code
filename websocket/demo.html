<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <title>iPhone Controlled Color Cube via Websockets</title>
  <meta name="generator" content="Mephisto" />
  <link rel="alternate" type="application/atom+xml" href="http://feeds.feedburner.com/tuupola" title="Atom feed" />
  <link href="http://www.appelsiini.net/stylesheets/main2.css" rel="stylesheet" type="text/css" />

  <style type="text/css">
  #sidebar {
    width: 0px;
  }

  #content {
    width: 770px;
  }
  
  </style>

</head>

<body>    
  <div id="wrap"> 
    <div id="header">
      <p>
        <h1>iPhone Controlled Color Cube</h1><br />
        <small>Lorem ipsum dolor sit amet.</small>
        <ul id="nav">
          <li id="first"><a href="/" class="active">weblog</a></li>
          <li><a href="/projects" class="last">projects</a></li>
          <!--
          <li><a href="/cv" class="last">cv</a></li>
        -->
        </ul>
      </p>
    </div>
    <div id="content">
    <div class="entry">
    <p>
      You can control this cube by tilting your iPhone. You must pair your iPhone and desktop browser. With your iPhone go to address <a href="http://appelsiini.net/demo/websocket/iphone.html">appelsiini.net/ws</a> and enter PIN code <b id="pin">xxxx</b>. When your iPhone says connected try tilting your phone and watch the cube on this browser.
    </p>
    
    <canvas id="canvas" width="765" height="570">
      Sorry, this demo requires a web browser which supports HTML5 canvas!
    </canvas>

    </div>
 
  <div id="sidebar">
  </div>
  
  <div id="footer">
  </div>

  <script src="http://code.jquery.com/jquery-1.4.3.min.js" type="text/javascript" charset="utf-8"></script>
  <script src="js/pre3d.js"></script>
  <script src="js/pre3d_shape_utils.js"></script>
  <script src="js/demo_utils.js"></script>
 
<script type="text/javascript" charset="utf-8">
$(function() {
 
    var black = new Pre3d.RGBA(0, 0, 0, 1);
    var white = new Pre3d.RGBA(1, 1, 1, 1);

    var screen_canvas = document.getElementById('canvas');
    var renderer = new Pre3d.Renderer(screen_canvas);

    var cubes = [ ];

    for (var i = 0; i < 10; ++i) {
        for (var j = 0; j < 10; ++j) {
            for (var k = 0; k < 10; ++k) {
                if (i == 0 || j == 0 || k == 0 ||
                    i == 9 || j == 9 || k == 9) {
                var cube = Pre3d.ShapeUtils.makeCube(0.5);
                var transform = new Pre3d.Transform();
                transform.translate(i - 5, j - 5, k - 5);
                cubes.push({
                    shape: cube,
                    color: new Pre3d.RGBA(i / 10, j / 10, k / 10, 0.3),
                    trans: transform});
                }
            }
        }
    }

    var num_cubes = cubes.length;

    function draw() {
        for (var i = 0; i < num_cubes; ++i) {
            var cube = cubes[i];
            renderer.fill_rgba = cube.color;
            renderer.transform = cube.trans;
            renderer.bufferShape(cube.shape);
        }

        renderer.ctx.setFillColor(0, 0, 0, 1);
        renderer.drawBackground();
        renderer.drawBuffer();
        renderer.emptyBuffer();
    }

    renderer.camera.focal_length = 2.5;

    var camera_state = {
        rotate_x: 10,
        rotate_y: 0,
        rotate_z: -30,
        x: 0.40,
        y: -1.06,
        z: -30
    };

    function set_camera() {
        var ct = renderer.camera.transform;
        ct.reset();
        ct.rotateZ(camera_state.rotate_z);
        ct.rotateY(camera_state.rotate_y);
        ct.rotateX(camera_state.rotate_x);
        ct.translate(camera_state.x, camera_state.y, camera_state.z);
    }

    var acceleration = { x: 0, y:0 };

    var interval = setInterval(function() {
        camera_state.rotate_y -= acceleration.x * 0.005;
        camera_state.rotate_x += acceleration.y * 0.005;
        set_camera();
        draw();
    }, 1);

    
    function pad(number, length) {

        var str = '' + number;
        while (str.length < length) {
            str = '0' + str;
        }

        return str;
    }
    
    
    var acceleration = {x : 0, y : 0};
    
    var pin = pad(Math.floor(Math.random() * 9999), 4);
    $("#pin").text(pin);
    
    // var socket = new WebSocket("ws://ws.appelsiini.net:8080/iphone/" + pin);
    var socket = new WebSocket("ws://192.168.1.79:8080/iphone/" + pin);

    socket.onopen = function(event) {
    };

    socket.onmessage = function(event) {
        var payload = JSON.parse(event.data);
        if (payload.acceleration) {
            acceleration = payload.acceleration;            
        }
        if (payload.server) {
            console.log(payload.server);            
        }
        if (payload.mobile) {
            console.log(payload.mobile);            
        }
    };

    socket.onclose = function(event) {
        console.log(event);
    };
    
});
</script>
   
  <script src="http://www.google-analytics.com/urchin.js" type="text/javascript"></script>
  <script type="text/javascript">
    _uacct = "UA-190966-1";
    //urchinTracker();
  </script>

</body>
</html>

